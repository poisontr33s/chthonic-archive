name: Validate Shell Probe

on:
  push:
    paths:
      - 'scripts/shell_capabilities.ps1'
      - 'scripts/validate_probe.ps1'
      - 'scripts/validate_shell_probe.ps1'
      - 'scripts/lint_shell_sovereignty.ps1'
      - 'scripts/bun_compliance_audit.py'
      - 'mcp/tools/preflightExecutionContext.ts'
      - 'mcp/tools/ExecutionContext.schema.json'
      - 'mcp/server.ts'
      - '.github/workflows/validate-probe.yml'
  pull_request:
    paths:
      - 'scripts/shell_capabilities.ps1'
      - 'scripts/validate_probe.ps1'
      - 'scripts/validate_shell_probe.ps1'
      - 'scripts/lint_shell_sovereignty.ps1'
      - 'scripts/bun_compliance_audit.py'
      - 'mcp/tools/preflightExecutionContext.ts'
      - 'mcp/tools/ExecutionContext.schema.json'
      - 'mcp/server.ts'
      - '.github/workflows/validate-probe.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Canonical Probe
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      # ========================================================================
      # REQUIRED: ABI Contract Hard Gate
      # ========================================================================
      - name: Validate ABI contract (REQUIRED)
        shell: pwsh
        run: |
          Write-Host "=== ABI Contract Enforcement (Hard Gate) ===" -ForegroundColor Cyan
          .\scripts\validate_shell_probe.ps1

          if ($LASTEXITCODE -ne 0) {
            Write-Error "ABI contract validation failed. CI blocked."
            exit 1
          }

      # ========================================================================
      # REQUIRED: Shell Sovereignty Hard Gate
      # ========================================================================
      - name: Enforce shell sovereignty (REQUIRED)
        shell: pwsh
        run: |
          Write-Host "=== Shell Sovereignty Enforcement (Hard Gate) ===" -ForegroundColor Cyan
          .\scripts\lint_shell_sovereignty.ps1

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Shell sovereignty violation detected. CI blocked."
            exit 1
          }

      # ========================================================================
      # REQUIRED: MCP Preflight Execution Context (Schema Validation)
      # ========================================================================
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: MCP preflight execution context (REQUIRED)
        shell: pwsh
        run: |
          Write-Host "=== MCP Preflight Execution Context (Hard Gate) ===" -ForegroundColor Cyan

          $request = @'
          {
            "jsonrpc": "2.0",
            "id": 1,
            "method": "tools/call",
            "params": {
              "name": "preflight_execution_context",
              "arguments": {}
            }
          }
          '@

          # Run MCP server and capture response
          Write-Host "Running preflight_execution_context..."
          $response = $request | bun run mcp/server.ts

          if (-not $response) {
            Write-Error "No response from MCP server"
            exit 1
          }

          # Parse JSON-RPC wrapper
          $rpc = $response | ConvertFrom-Json

          if (-not $rpc.result.content[0].text) {
            Write-Error "Missing MCP content payload"
            exit 1
          }

          # Extract execution context payload
          $payload = $rpc.result.content[0].text | ConvertFrom-Json
          $payload | ConvertTo-Json -Depth 10 | Out-File preflight_response.json -Encoding utf8

          Write-Host "Validating response against schema..."

          # Validate with ajv (bun-compatible)
          bunx ajv-cli validate `
            -s mcp/tools/ExecutionContext.schema.json `
            -d preflight_response.json `
            --strict=false

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Preflight schema validation failed. CI blocked."
            exit 1
          }

          Write-Host "✓ Preflight execution context validated successfully" -ForegroundColor Green

      # ========================================================================
      # REQUIRED: Bun Compliance Audit (Hard Gate)
      # ========================================================================
      - name: Bun compliance audit (REQUIRED)
        shell: pwsh
        run: |
          Write-Host "=== Bun Compliance Enforcement (Hard Gate) ===" -ForegroundColor Cyan
          uv run python scripts/bun_compliance_audit.py --ci

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Bun compliance violations detected. CI blocked per SSOT ºXIV.2"
            exit 1
          }

          Write-Host "✓ Bun compliance validated successfully" -ForegroundColor Green

      # ========================================================================
      # ADVISORY: Style and Quality Checks (Non-blocking)
      # ========================================================================
      - name: Run advisory checks (non-blocking)
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "`n=== Advisory Checks (Non-blocking) ===" -ForegroundColor Yellow

          # Test probe execution
          Write-Host "`n[Advisory] Testing probe execution..." -ForegroundColor Yellow
          $json = .\scripts\shell_capabilities.ps1 | ConvertFrom-Json
          Write-Host "  ✓ Probe executed successfully" -ForegroundColor Green
          Write-Host "    OS: $($json.os)"
          Write-Host "    PowerShell: $($json.pwsh_version)"
          Write-Host "    Path entries: $($json.path.Count)"

          # Scan for variants
          Write-Host "`n[Advisory] Scanning for probe variants..." -ForegroundColor Yellow
          $canonical = "6D6782ED8FFC4BF434D2A7108A0F3BACF13C3B40CC5C8F00F53CB789A96D9DF8"

          Get-ChildItem -Path . -Filter "*.ps1" -Recurse -File |
            Where-Object { $_.Name -like "*shell*" -or $_.Name -like "*probe*" -or $_.Name -like "*capabilities*" } |
            ForEach-Object {
              $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
              $isCanonical = if ($hash -eq $canonical) { "✓ CANONICAL" } else { "⚠ VARIANT" }

              [PSCustomObject]@{
                Path = $_.FullName.Replace("$PWD\", "")
                Status = $isCanonical
                Hash = $hash.Substring(0, 16) + "..."
              }
            } | Format-Table -AutoSize

          Write-Host "`nℹ These advisory checks provide insights but do not block CI." -ForegroundColor DarkGray

      # ========================================================================
      # Summary
      # ========================================================================
      - name: Validation summary
        shell: pwsh
        run: |
          Write-Host "`n=== Validation Complete ===" -ForegroundColor Green
          Write-Host "✓ ABI contract validated (hard gate passed)" -ForegroundColor Green
          Write-Host "✓ Shell sovereignty enforced (hard gate passed)" -ForegroundColor Green
          Write-Host "✓ MCP preflight schema validated (hard gate passed)" -ForegroundColor Green
          Write-Host "✓ Bun compliance enforced (hard gate passed)" -ForegroundColor Green
          Write-Host "✓ Advisory checks completed (informational only)" -ForegroundColor Green
          Write-Host "`nCanonical probe: scripts/shell_capabilities.ps1" -ForegroundColor Cyan
          Write-Host "Hash: 6D6782ED8FFC4BF434D2A7108A0F3BACF13C3B40CC5C8F00F53CB789A96D9DF8" -ForegroundColor DarkGray
