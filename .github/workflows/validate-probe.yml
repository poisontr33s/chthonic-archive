name: Validate Shell Probe

on:
  push:
    paths:
      - 'scripts/shell_capabilities.ps1'
      - 'scripts/validate_probe.ps1'
      - 'scripts/validate_shell_probe.ps1'
      - '.github/workflows/validate-probe.yml'
  pull_request:
    paths:
      - 'scripts/shell_capabilities.ps1'
      - 'scripts/validate_probe.ps1'
      - 'scripts/validate_shell_probe.ps1'
      - '.github/workflows/validate-probe.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Canonical Probe
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      # ========================================================================
      # REQUIRED: ABI Contract Hard Gate
      # ========================================================================
      - name: Validate ABI contract (REQUIRED)
        shell: pwsh
        run: |
          Write-Host "=== ABI Contract Enforcement (Hard Gate) ===" -ForegroundColor Cyan
          .\scripts\validate_shell_probe.ps1

          if ($LASTEXITCODE -ne 0) {
            Write-Error "ABI contract validation failed. CI blocked."
            exit 1
          }

      # ========================================================================
      # ADVISORY: Style and Quality Checks (Non-blocking)
      # ========================================================================
      - name: Run advisory checks (non-blocking)
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "`n=== Advisory Checks (Non-blocking) ===" -ForegroundColor Yellow

          # Test probe execution
          Write-Host "`n[Advisory] Testing probe execution..." -ForegroundColor Yellow
          $json = .\scripts\shell_capabilities.ps1 | ConvertFrom-Json
          Write-Host "  ✓ Probe executed successfully" -ForegroundColor Green
          Write-Host "    OS: $($json.os)"
          Write-Host "    PowerShell: $($json.pwsh_version)"
          Write-Host "    Path entries: $($json.path.Count)"

          # Scan for variants
          Write-Host "`n[Advisory] Scanning for probe variants..." -ForegroundColor Yellow
          $canonical = "6D6782ED8FFC4BF434D2A7108A0F3BACF13C3B40CC5C8F00F53CB789A96D9DF8"

          Get-ChildItem -Path . -Filter "*.ps1" -Recurse -File |
            Where-Object { $_.Name -like "*shell*" -or $_.Name -like "*probe*" -or $_.Name -like "*capabilities*" } |
            ForEach-Object {
              $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
              $isCanonical = if ($hash -eq $canonical) { "✓ CANONICAL" } else { "⚠ VARIANT" }

              [PSCustomObject]@{
                Path = $_.FullName.Replace("$PWD\", "")
                Status = $isCanonical
                Hash = $hash.Substring(0, 16) + "..."
              }
            } | Format-Table -AutoSize

          Write-Host "`nℹ These advisory checks provide insights but do not block CI." -ForegroundColor DarkGray

      # ========================================================================
      # Summary
      # ========================================================================
      - name: Validation summary
        shell: pwsh
        run: |
          Write-Host "`n=== Validation Complete ===" -ForegroundColor Green
          Write-Host "✓ ABI contract validated (hard gate passed)" -ForegroundColor Green
          Write-Host "✓ Advisory checks completed (informational only)" -ForegroundColor Green
          Write-Host "`nCanonical probe: scripts/shell_capabilities.ps1" -ForegroundColor Cyan
          Write-Host "Hash: 6D6782ED8FFC4BF434D2A7108A0F3BACF13C3B40CC5C8F00F53CB789A96D9DF8" -ForegroundColor DarkGray
