"use strict";exports.id=580,exports.ids=[580],exports.modules={6580:(a,b,c)=>{c.d(b,{p:()=>v}),c(6760);var d=c(9748),e=c(9021),f=c(3873),g=c.n(f);let h={port:Number(process.env.PORT)||4e3,host:process.env.HOST||"127.0.0.1",gpuProvider:process.env.GENESIS_GPU_PROVIDER||"CUDA+TensorRT",slo:{acceptanceRate:Number(process.env.SLO_ACCEPTANCE_RATE)||.35,p50LatencyMs:Number(process.env.SLO_P50_LATENCY_MS)||50,p95LatencyMs:Number(process.env.SLO_P95_LATENCY_MS)||200,vramPct:Number(process.env.SLO_VRAM_PCT)||90}},i={logsDir:()=>g().resolve(void 0,"..",process.env.GENESIS_LOGS_DIR||"../logs/genesis"),artifactsDir:()=>g().resolve(void 0,"..",process.env.GENESIS_ARTIFACTS_DIR||"../genesis_artifacts"),entityRegistry:()=>g().resolve(void 0,"..",process.env.ENTITY_REGISTRY_PATH||"../data/entity_registry.json")};function j(a){let b={acceptance_rate:a.acceptanceRate>=h.slo.acceptanceRate,p50_latency:a.p50Ms<=h.slo.p50LatencyMs,p95_latency:a.p95Ms<=h.slo.p95LatencyMs,vram:a.vramPct<=h.slo.vramPct};return{...b,overall:Object.values(b).every(Boolean)}}async function k(a){let b=i.logsDir();if(!(0,e.existsSync)(b))return console.warn(`[artifacts] Logs directory not found: ${b}`),[];let c=(await (0,d.readdir)(b)).filter(a=>a.startsWith("cycle_")&&a.endsWith(".json")),f=a?.replace(/-/g,"")||"",h=f?c.filter(a=>a.includes(f)):c,j=[];for(let a of h)try{let c=g().join(b,a),d=await Bun.file(c).json();!d.timestamp&&d.cycle_id&&(d.timestamp=d.cycle_id),j.push(d)}catch(b){console.error(`[artifacts] Failed to read ${a}:`,b)}return j.sort((a,b)=>{let c=a.timestamp||a.cycle_id||"";return(b.timestamp||b.cycle_id||"").localeCompare(c)})}async function l(a){let b=i.logsDir(),c=g().join(b,`cycle_${a}.json`);if(!(0,e.existsSync)(c))return null;try{return await Bun.file(c).json()}catch{return null}}function m(a,b){if(0===b.length)return{date:a,total_cycles:0,total_generated:0,total_accepted:0,acceptance_rate:0,latency:{p50:0,p95:0,p99:0},vram_max:0,degraded_cycles:0,error_cycles:0,slo_compliance:{acceptance_rate:!1,p50_latency:!0,p95_latency:!0,vram:!0}};let c=b.reduce((a,b)=>a+(b.generated||b.attempts||0),0),d=b.reduce((a,b)=>a+b.accepted,0),e=b.map(a=>a.latency_p50_ms).filter(a=>a>0),f=b.map(a=>a.latency_p95_ms).filter(a=>a>0),g=b.map(a=>a.latency_p99_ms).filter(a=>a>0),h=Math.max(...b.map(a=>a.vram_usage_pct||0),0),i=e.length>0?e.reduce((a,b)=>a+b,0)/e.length:0,k=f.length>0?f.reduce((a,b)=>a+b,0)/f.length:0,l=g.length>0?g.reduce((a,b)=>a+b,0)/g.length:0,m=c>0?d/c:0;return{date:a,total_cycles:b.length,total_generated:c,total_accepted:d,acceptance_rate:m,latency:{p50:i,p95:k,p99:l},vram_max:h,degraded_cycles:b.filter(a=>a.degraded_mode).length,error_cycles:b.filter(a=>a.error).length,slo_compliance:j({acceptanceRate:m,p50Ms:i,p95Ms:k,vramPct:h})}}async function n(a){let b=a||new Date().toISOString().slice(0,10),c=await k(b);return m(b,c)}async function o(){let a=i.entityRegistry();if(!(0,e.existsSync)(a))return console.warn(`[artifacts] Entity registry not found: ${a}`),[];try{let b=await Bun.file(a).json();return Array.isArray(b)?b:b.entities||[]}catch(a){return console.error("[artifacts] Failed to read entity registry:",a),[]}}async function p(a=10){let b=i.artifactsDir();if(!(0,e.existsSync)(b))return[];try{let c=(await (0,d.readdir)(b)).sort().reverse().slice(0,a),f=[];for(let a of c){let c=g().join(b,a,"entity.json");if((0,e.existsSync)(c))try{let a=await Bun.file(c).json();f.push(a)}catch{}}return f}catch{return[]}}async function q(){let a=i.artifactsDir();if(!(0,e.existsSync)(a))return console.warn(`[artifacts] Artifacts directory not found: ${a}`),[];try{let b=(await (0,d.readdir)(a)).filter(a=>a.startsWith("monitoring_score")&&a.endsWith(".json")),c=[];for(let d of b)try{let b=g().join(a,d),e=await Bun.file(b).json();if(!e.timestamp){let a=d.match(/monitoring_score_(\d{8})T?(\d{6})?/);if(a){let b=a[1],c=a[2]||"000000";e.timestamp=`${b.slice(0,4)}-${b.slice(4,6)}-${b.slice(6,8)}T${c.slice(0,2)}:${c.slice(2,4)}:${c.slice(4,6)}Z`}else e.timestamp=new Date().toISOString()}c.push(e)}catch(a){console.error(`[artifacts] Failed to read ${d}:`,a)}return c.sort((a,b)=>a.timestamp.localeCompare(b.timestamp))}catch(a){return console.error("[artifacts] Failed to read monitoring score history:",a),[]}}async function r(){let a=i.artifactsDir(),b=g().join(a,"monitoring_score.json");if((0,e.existsSync)(b))try{return await Bun.file(b).json()}catch(a){console.error("[artifacts] Failed to read monitoring_score.json:",a)}let c=(await k()).filter(a=>{let b=new Date(a.timestamp||a.cycle_id);return new Date().getTime()-b.getTime()<864e5}),d=c.reduce((a,b)=>a+(b.generated||b.attempts||0),0),f=c.reduce((a,b)=>a+b.accepted,0),h=d>0?f/d*100:0,l=c.map(a=>a.latency_p50_ms).filter(a=>a>0),m=c.map(a=>a.latency_p95_ms).filter(a=>a>0),n=l.length>0?l.reduce((a,b)=>a+b)/l.length:0,o=m.length>0?m.reduce((a,b)=>a+b)/m.length:0,p=c.filter(a=>a.error).length;return{timestamp:new Date().toISOString(),acceptance_pct:h,latency_p50_ms:n,latency_p95_ms:o,error_count:p,quality_score:h,slo_compliance:j({acceptanceRate:h/100,p50Ms:n,p95Ms:o,vramPct:0}),cycle_count:c.length,window_hours:24}}var s=c(3731);class t{constructor(a){this.state={status:"idle"},this.activeProcess=null,this.config={projectRoot:a?.projectRoot??(0,f.join)((0,f.dirname)(void 0),".."),pythonVersion:a?.pythonVersion??"3.13",verbose:a?.verbose??!1}}getState(){return{...this.state}}isRunning(){return"spawned"===this.state.status||"processing"===this.state.status}async startCycle(a={}){if(this.isRunning())throw Error("Cycle already in progress. Wait for completion or call abort().");let b=a.timeout??3e5,c=this.buildArgs(a);this.state={status:"spawned",startTime:Date.now()};try{let a=await this.executeWithTimeout(c,b);return this.state={status:"complete"},a}catch(a){throw this.state={status:"error",lastUpdate:a instanceof Error?a.message:String(a)},a}}abort(){return!!(this.activeProcess&&this.isRunning())&&(this.activeProcess.kill("SIGTERM"),this.state={status:"idle"},this.activeProcess=null,!0)}buildArgs(a){let b=["uv","run","scripts/run_cycle.py"];return!1!==a.quiet&&b.push("--quiet"),a.cpuOnly&&b.push("--cpu-only"),a.milfs&&a.milfs.length>0&&b.push("--milfs",a.milfs.join(",")),b}async executeWithTimeout(a,b){return new Promise((c,d)=>{let e=setTimeout(()=>{this.abort(),this.state={status:"timeout"},d(Error(`Cycle timed out after ${b}ms`))},b);this.spawnProcess(a).then(c).catch(d).finally(()=>clearTimeout(e))})}async spawnProcess(a){let b=this.buildEnvironment();this.config.verbose&&(console.error(`[Activator] Spawning: ${a.join(" ")}`),console.error(`[Activator] CWD: ${this.config.projectRoot}`)),this.activeProcess=(0,s.spawn)(a,{cwd:this.config.projectRoot,env:b,stdin:"ignore",stdout:"pipe",stderr:"pipe"}),this.state.pid=this.activeProcess.pid,this.state.status="processing";let[c,d]=await Promise.all([this.collectStream(this.activeProcess.stdout),this.collectStream(this.activeProcess.stderr)]),e=await this.activeProcess.exited;if(this.activeProcess=null,this.config.verbose&&d&&console.error(`[Activator] stderr:
${d}`),0!==e)throw Error(`Cycle failed with exit code ${e}: ${d||c}`);try{return JSON.parse(c.trim())}catch(a){throw Error(`Failed to parse cycle output as JSON: ${c.substring(0,200)}`)}}buildEnvironment(){return{...process.env,UV_NO_PROGRESS:"1",UV_PYTHON:this.config.pythonVersion,NO_COLOR:"1",FORCE_COLOR:"0",PYTHONUNBUFFERED:"1"}}async collectStream(a){if(!a||"number"==typeof a)return"";let b=[],c=a.getReader();try{for(;;){let{done:a,value:d}=await c.read();if(a)break;d&&b.push(d)}}finally{c.releaseLock()}let d=new TextDecoder;return b.map(a=>d.decode(a)).join("")}}async function u(a){if(!a||"number"==typeof a)return"";let b=[],c=a.getReader();try{for(;;){let{done:a,value:d}=await c.read();if(a)break;d&&b.push(d)}}finally{c.releaseLock()}let d=new TextDecoder;return b.map(a=>d.decode(a)).join("")}t.prototype.checkStatus=async function(){let a=this.getState();return{running:this.isRunning(),status:a.status,pid:a.pid,uptime_ms:a.startTime?Date.now()-a.startTime:void 0,last_update:a.lastUpdate}},t.prototype.runProbe=async function(){let a=Date.now();try{let b=(0,s.spawn)(["uv","run","scripts/probe_gpu_compatibility.py","--json"],{cwd:this.config.projectRoot,env:{...process.env,UV_NO_PROGRESS:"1",PYTHONUNBUFFERED:"1",NO_COLOR:"1"},stdin:"ignore",stdout:"pipe",stderr:"pipe"}),[c,d]=await Promise.all([u(b.stdout),u(b.stderr)]),e=await b.exited,f=Date.now()-a;if(0!==e)return{success:!1,duration_ms:f,cuda_available:!1,errors:[d||`Exit code ${e}`]};try{let a=JSON.parse(c.trim());return{success:!0,duration_ms:f,cuda_available:a.cuda?.available??!1,cuda_version:a.cuda?.version,cudnn_available:a.cudnn?.available,tensorrt_available:a.tensorrt?.available,onnx_providers:a.onnx?.providers,gpu_name:a.cuda?.device_name,gpu_memory_mb:a.cuda?.memory_total_mb,data:a}}catch{return{success:!1,duration_ms:f,cuda_available:!1,errors:[`Failed to parse probe output: ${c.substring(0,200)}`]}}}catch(b){return{success:!1,duration_ms:Date.now()-a,cuda_available:!1,errors:[b instanceof Error?b.message:String(b)]}}},t.prototype.activateMilfs=async function(a={}){let{profile:b="inference_default",dry_run:c=!1}=a,d=["uv","run","scripts/milf_activator.py","--profile",b,"--json"];c&&d.push("--dry-run");try{let a=(0,s.spawn)(d,{cwd:this.config.projectRoot,env:{...process.env,UV_NO_PROGRESS:"1",PYTHONUNBUFFERED:"1",NO_COLOR:"1"},stdin:"ignore",stdout:"pipe",stderr:"pipe"}),[c,e]=await Promise.all([u(a.stdout),u(a.stderr)]),f=await a.exited;if(0!==f)return{success:!1,profile_used:b,activated:[],rejected:[],summary:{total:0,activated:0,rejected:0},error:e||`Exit code ${f}`};try{let a=JSON.parse(c.trim());return{success:!0,profile_used:b,activated:a.activated??[],rejected:a.rejected??[],summary:a.summary??{total:0,activated:0,rejected:0}}}catch{return{success:!1,profile_used:b,activated:[],rejected:[],summary:{total:0,activated:0,rejected:0},error:`Failed to parse activator output: ${c.substring(0,200)}`}}}catch(a){return{success:!1,profile_used:b,activated:[],rejected:[],summary:{total:0,activated:0,rejected:0},error:a instanceof Error?a.message:String(a)}}};let v={async getDigest(){try{let a=await n();return Response.json(a)}catch(a){return console.error("[API] getDigest error:",a),Response.json({error:"Failed to load digest"},{status:500})}},async getDigestByDate(a){let b=new URL(a.url).pathname.split("/").pop();if(!b||!/^\d{4}-?\d{2}-?\d{2}$/.test(b))return Response.json({error:"Invalid date format"},{status:400});try{let a=await n(b);return Response.json(a)}catch(a){return console.error("[API] getDigestByDate error:",a),Response.json({error:"Failed to load digest"},{status:500})}},async getCycles(a){let b=new URL(a.url),c=b.searchParams.get("date")||void 0,d=Number(b.searchParams.get("limit"))||50,e=Number(b.searchParams.get("offset"))||0;try{let a=await k(c),b=a.slice(e,e+d);return Response.json({data:b,total:a.length,limit:d,offset:e,has_more:e+d<a.length})}catch(a){return console.error("[API] getCycles error:",a),Response.json({error:"Failed to load cycles"},{status:500})}},async getCycleById(a){let b=new URL(a.url).pathname.split("/").pop();if(!b)return Response.json({error:"Cycle ID required"},{status:400});try{let a=await l(b);if(!a)return Response.json({error:"Cycle not found"},{status:404});return Response.json(a)}catch(a){return console.error("[API] getCycleById error:",a),Response.json({error:"Failed to load cycle"},{status:500})}},async getMetrics(){try{let a=new Date().toISOString().slice(0,10),b=await k(),c=new Map;for(let a of b){let b=(a.timestamp||a.cycle_id).slice(0,10);c.has(b)||c.set(b,[]),c.get(b).push(a)}let d=Array.from(c.entries()).map(([a,b])=>m(a,b)).sort((a,b)=>b.date.localeCompare(a.date)).slice(0,7);return Response.json({current_date:a,days:d,totals:{cycles:d.reduce((a,b)=>a+b.total_cycles,0),generated:d.reduce((a,b)=>a+b.total_generated,0),accepted:d.reduce((a,b)=>a+b.total_accepted,0)}})}catch(a){return console.error("[API] getMetrics error:",a),Response.json({error:"Failed to load metrics"},{status:500})}},async getEntities(){try{let a=await o();return Response.json({data:a,total:a.length})}catch(a){return console.error("[API] getEntities error:",a),Response.json({error:"Failed to load entities"},{status:500})}},async getRecentEntities(a){let b=Number(new URL(a.url).searchParams.get("limit"))||10;try{let a=await p(b);return Response.json({data:a,total:a.length})}catch(a){return console.error("[API] getRecentEntities error:",a),Response.json({error:"Failed to load recent entities"},{status:500})}},async getMonitoringScore(){try{let a=await r();return Response.json(a)}catch(a){return console.error("[API] getMonitoringScore error:",a),Response.json({error:"Failed to load monitoring score"},{status:500})}},async getMetricsHistory(){try{let a=await q();return Response.json({data:a,total:a.length,oldest:a.length>0?a[0].timestamp:null,newest:a.length>0?a[a.length-1].timestamp:null})}catch(a){return console.error("[API] getMetricsHistory error:",a),Response.json({error:"Failed to load metrics history"},{status:500})}}};new t}};